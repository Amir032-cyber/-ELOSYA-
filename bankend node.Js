// ===== FICHIER 7: backend-ai-proxy.js =====
// Backend Node.js Express pour sÃ©curiser l'API Elosya

const express = require('express');
const cors = require('cors');
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');
const axios = require('axios');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

// ===== CONFIGURATION =====
const ELOSYA_AI_CONFIG = {
    OPENAI_API_KEY: process.env.OPENAI_API_KEY || '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',
    RATE_LIMIT_WINDOW: 15 * 60 * 1000, // 15 minutes
    RATE_LIMIT_MAX: 100, // 100 requÃªtes par fenÃªtre
    MAX_TOKENS: 2000,
    SYSTEM_PROMPT: `Tu es Lam.AI, l'assistant IA intÃ©grÃ© Ã  Elosya, une plateforme vidÃ©o franÃ§aise.
RÃ¨gles :
1. RÃ©ponds toujours en franÃ§ais sauf demande contraire
2. Sois professionnel, utile et crÃ©atif
3. Aide avec les sujets vidÃ©o, crÃ©ation de contenu, marketing, technique
4. Recommande du contenu Elosya quand c'est pertinent
5. Propose des idÃ©es pour amÃ©liorer les vidÃ©os des crÃ©ateurs
6. Formate tes rÃ©ponses avec des listes, titres et emojis quand c'est utile
7. Sois enthousiaste et encourageant !`
};

// ===== MIDDLEWARES =====
app.use(helmet()); // SÃ©curitÃ© HTTP
app.use(cors({
    origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
    credentials: true
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Rate limiting par IP
const limiter = rateLimit({
    windowMs: ELOSYA_AI_CONFIG.RATE_LIMIT_WINDOW,
    max: ELOSYA_AI_CONFIG.RATE_LIMIT_MAX,
    message: { error: 'Trop de requÃªtes, veuillez rÃ©essayer plus tard.' }
});
app.use('/api/ai/', limiter);

// ===== ROUTES API =====

// 1. SantÃ© du serveur
app.get('/api/health', (req, res) => {
    res.json({
        status: 'OK',
        service: 'Elosya AI Backend',
        version: '1.0.0',
        timestamp: new Date().toISOString()
    });
});

// 2. Chat IA principal
app.post('/api/ai/chat', async (req, res) => {
    try {
        const { messages, model = 'gpt-3.5-turbo', temperature = 0.7 } = req.body;
        const userId = req.headers['x-user-id'] || req.ip;

        // Validation
        if (!messages || !Array.isArray(messages)) {
            return res.status(400).json({ error: 'Messages invalides' });
        }

        // PrÃ©parer la requÃªte pour OpenAI
        const requestBody = {
            model: model,
            messages: [
                { role: 'system', content: ELOSYA_AI_CONFIG.SYSTEM_PROMPT },
                ...messages
            ],
            temperature: temperature,
            max_tokens: ELOSYA_AI_CONFIG.MAX_TOKENS,
            top_p: 0.9,
            frequency_penalty: 0,
            presence_penalty: 0
        };

        // Logger la requÃªte (sans le contenu complet pour la confidentialitÃ©)
        console.log(`[AI Request] User: ${userId}, Model: ${model}, Messages: ${messages.length}`);

        // Appeler l'API OpenAI
        const response = await axios.post(
            'https://api.openai.com/v1/chat/completions',
            requestBody,
            {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ELOSYA_AI_CONFIG.OPENAI_API_KEY}`
                },
                timeout: 30000 // 30 secondes timeout
            }
        );

        // Extraire la rÃ©ponse
        const aiResponse = response.data.choices[0].message.content;
        const usage = response.data.usage;

        // Logger l'utilisation
        console.log(`[AI Response] Tokens: ${usage.total_tokens}, User: ${userId}`);

        // Retourner la rÃ©ponse
        res.json({
            success: true,
            message: aiResponse,
            usage: usage,
            model: model,
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error('[AI Error]', error.response?.data || error.message);
        
        // Gestion des erreurs spÃ©cifiques
        if (error.response?.status === 401) {
            return res.status(500).json({ error: 'Erreur d\'authentification API' });
        }
        if (error.response?.status === 429) {
            return res.status(429).json({ error: 'Limite de quota dÃ©passÃ©e' });
        }
        if (error.code === 'ECONNABORTED') {
            return res.status(504).json({ error: 'Timeout de l\'API' });
        }
        
        res.status(500).json({ 
            error: 'Erreur du serveur IA',
            details: process.env.NODE_ENV === 'development' ? error.message : undefined
        });
    }
});

// 3. Analyse de vidÃ©o (fonction spÃ©ciale)
app.post('/api/ai/analyze-video', async (req, res) => {
    try {
        const { title, description, metrics, category } = req.body;
        const userId = req.headers['x-user-id'];

        if (!title || !description) {
            return res.status(400).json({ error: 'Titre et description requis' });
        }

        const prompt = `Analyse cette vidÃ©o Elosya et donne des conseils d'amÃ©lioration:

TITRE: "${title}"
DESCRIPTION: "${description}"
CATÃ‰GORIE: ${category || 'Non spÃ©cifiÃ©e'}
MÃ‰TRIQUES: ${metrics ? JSON.stringify(metrics) : 'Non disponibles'}

Donne une analyse structurÃ©e avec:
1. Ã‰valuation du titre/description (SEO, attractivitÃ©)
2. Suggestions d'amÃ©lioration concrÃ¨tes
3. Hashtags recommandÃ©s (10 maximum)
4. StratÃ©gie de promotion spÃ©cifique
5. IdÃ©es pour la prochaine vidÃ©o dans la sÃ©rie

Sois prÃ©cis, pratique et encourageant !`;

        const requestBody = {
            model: 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.7,
            max_tokens: 1500
        };

        const response = await axios.post(
            'https://api.openai.com/v1/chat/completions',
            requestBody,
            {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ELOSYA_AI_CONFIG.OPENAI_API_KEY}`
                }
            }
        );

        const analysis = response.data.choices[0].message.content;

        res.json({
            success: true,
            analysis: analysis,
            type: 'video_analysis',
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error('[Video Analysis Error]', error.message);
        res.status(500).json({ error: 'Erreur lors de l\'analyse' });
    }
});

// 4. GÃ©nÃ©ration d'idÃ©es de vidÃ©os
app.post('/api/ai/generate-ideas', async (req, res) => {
    try {
        const { topic, count = 5, style = 'educational' } = req.body;

        if (!topic) {
            return res.status(400).json({ error: 'ThÃ¨me requis' });
        }

        const prompt = `En tant qu'expert en crÃ©ation de contenu vidÃ©o pour Elosya, propose ${count} idÃ©es de vidÃ©os sur le thÃ¨me: "${topic}".

Style: ${style}

Pour chaque idÃ©e, fournis:
1. Titre accrocheur (max 60 caractÃ¨res)
2. Description courte (1-2 phrases)
3. DurÃ©e recommandÃ©e
4. Type de format (tutoriel, vlog, interview, etc.)
5. 5 hashtags pertinents
6. Public cible
7. DifficultÃ© de production (Facile/Moyen/Difficile)

Formate la rÃ©ponse en JSON valide.`;

        const requestBody = {
            model: 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.8,
            max_tokens: 2000,
            response_format: { type: "json_object" }
        };

        const response = await axios.post(
            'https://api.openai.com/v1/chat/completions',
            requestBody,
            {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ELOSYA_AI_CONFIG.OPENAI_API_KEY}`
                }
            }
        );

        const ideasJson = response.data.choices[0].message.content;
        const ideas = JSON.parse(ideasJson);

        res.json({
            success: true,
            ideas: ideas,
            count: count,
            topic: topic,
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error('[Ideas Generation Error]', error.message);
        res.status(500).json({ error: 'Erreur lors de la gÃ©nÃ©ration d\'idÃ©es' });
    }
});

// 5. GÃ©nÃ©ration de description YouTube
app.post('/api/ai/generate-description', async (req, res) => {
    try {
        const { title, keywords = [], videoType = 'tutorial', duration } = req.body;

        if (!title) {
            return res.status(400).json({ error: 'Titre requis' });
        }

        const prompt = `GÃ©nÃ¨re une description YouTube/Elosya professionnelle pour la vidÃ©o: "${title}"

Type de vidÃ©o: ${videoType}
DurÃ©e: ${duration || 'Non spÃ©cifiÃ©e'}
Mots-clÃ©s: ${keywords.length > 0 ? keywords.join(', ') : 'Aucun'}

Instructions:
- Longueur: 150-300 mots
- Format optimisÃ© pour le SEO YouTube
- Inclure des appels Ã  l'action (like, abonnement, commentaire, cloche)
- Ajouter des timestamps si pertinent
- Utiliser des emojis modÃ©rÃ©ment (max 5)
- Ajouter des liens pertinents
- Inclure des crÃ©dits si nÃ©cessaire

Structure recommandÃ©e:
1. Introduction accrocheuse
2. Description du contenu
3. Timestamps (si tutoriel)
4. Appels Ã  l'action
5. Liens utiles
6. Hashtags

Fournis aussi 10 hashtags pertinents.`;

        const requestBody = {
            model: 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.7,
            max_tokens: 1000
        };

        const response = await axios.post(
            'https://api.openai.com/v1/chat/completions',
            requestBody,
            {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ELOSYA_AI_CONFIG.OPENAI_API_KEY}`
                }
            }
        );

        const description = response.data.choices[0].message.content;

        res.json({
            success: true,
            description: description,
            title: title,
            videoType: videoType,
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error('[Description Generation Error]', error.message);
        res.status(500).json({ error: 'Erreur lors de la gÃ©nÃ©ration' });
    }
});

// 6. VÃ©rification d'API key
app.get('/api/ai/check', async (req, res) => {
    try {
        const response = await axios.get('https://api.openai.com/v1/models', {
            headers: {
                'Authorization': `Bearer ${ELOSYA_AI_CONFIG.OPENAI_API_KEY}`
            },
            timeout: 10000
        });

        res.json({
            success: true,
            message: 'API OpenAI fonctionnelle',
            models: response.data.data.slice(0, 10).map(m => m.id),
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        res.status(500).json({
            success: false,
            error: 'API OpenAI non accessible',
            details: error.message
        });
    }
});

// 7. Statistiques d'utilisation
app.get('/api/ai/stats', (req, res) => {
    // Ici tu pourrais connecter Ã  une base de donnÃ©es
    // Pour l'instant, retourne des stats basiques
    res.json({
        success: true,
        stats: {
            totalRequests: 0, // Ã€ implÃ©menter avec une DB
            activeUsers: 0,
            popularModels: ['gpt-3.5-turbo'],
            averageResponseTime: '1.2s'
        },
        timestamp: new Date().toISOString()
    });
});

// ===== GESTION DES ERREURS =====
app.use((req, res, next) => {
    res.status(404).json({ error: 'Route non trouvÃ©e' });
});

app.use((err, req, res, next) => {
    console.error('[Server Error]', err.stack);
    res.status(500).json({ 
        error: 'Erreur interne du serveur',
        ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
    });
});

// ===== DÃ‰MARRAGE DU SERVEUR =====
app.listen(PORT, () => {
    console.log(`ğŸš€ Serveur Elosya AI dÃ©marrÃ© sur le port ${PORT}`);
    console.log(`ğŸ”— URL: http://localhost:${PORT}`);
    console.log(`ğŸ“Š Health check: http://localhost:${PORT}/api/health`);
    console.log(`ğŸ¤– API AI: http://localhost:${PORT}/api/ai/chat`);
});

// ===== GESTION DES SIGNALS =====
process.on('SIGTERM', () => {
    console.log('ğŸ›‘ Signal SIGTERM reÃ§u. ArrÃªt gracieux...');
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('ğŸ›‘ Signal SIGINT reÃ§u. ArrÃªt du serveur...');
    process.exit(0);
});

// Export pour les tests
module.exports = app;
